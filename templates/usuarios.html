{% extends 'dev_base.html' %}

{% block title %}Gerenciamento de Usuários{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-users me-2"></i>Gerenciamento de Usuários
            </h1>
            <p class="text-muted">Gerencie usuários, permissões e níveis de acesso do sistema</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="abrirModalNovoUsuario()">
                <i class="fas fa-plus me-2"></i>Novo Usuário
            </button>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total de Usuários
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-usuarios">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Usuários Ativos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="usuarios-ativos">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Administradores
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="administradores">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-shield fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Último Acesso
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="ultimo-acesso">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filtros</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="buscar-usuario" placeholder="Nome, email ou usuário...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="filtro-status">
                        <option value="">Todos</option>
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                        <option value="suspenso">Suspenso</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Nível</label>
                    <select class="form-select" id="filtro-nivel">
                        <option value="">Todos</option>
                        <option value="admin">Administrador</option>
                        <option value="gerente">Gerente</option>
                        <option value="usuario">Usuário</option>
                        <option value="visualizador">Visualizador</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ordenar</label>
                    <select class="form-select" id="ordenar-por">
                        <option value="nome">Nome</option>
                        <option value="data_criacao">Data de Criação</option>
                        <option value="ultimo_acesso">Último Acesso</option>
                        <option value="nivel">Nível</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                        <button class="btn btn-secondary" onclick="limparFiltros()">
                            <i class="fas fa-times me-1"></i>Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Usuários -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Usuários do Sistema</h6>
            <div class="text-muted">
                <span id="total-resultados">0</span> usuário(s) encontrado(s)
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="tabela-usuarios">
                    <thead class="table-light">
                        <tr>
                            <th>Usuário</th>
                            <th>Nome Completo</th>
                            <th>Email</th>
                            <th>Nível</th>
                            <th>Status</th>
                            <th>Último Acesso</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="lista-usuarios">
                        <!-- Usuários serão carregados aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Usuário -->
<div class="modal fade" id="modalNovoUsuario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Novo Usuário
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNovoUsuario">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nome de Usuário *</label>
                                <input type="text" class="form-control" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nome Completo *</label>
                                <input type="text" class="form-control" name="first_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sobrenome</label>
                                <input type="text" class="form-control" name="last_name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Senha *</label>
                                <input type="password" class="form-control" name="password" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Confirmar Senha *</label>
                                <input type="password" class="form-control" name="password_confirm" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nível de Acesso *</label>
                                <select class="form-select" name="nivel_acesso" required>
                                    <option value="">Selecione...</option>
                                    <option value="visualizador">Visualizador</option>
                                    <option value="usuario">Usuário</option>
                                    <option value="gerente">Gerente</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="observacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarUsuario()">
                    <i class="fas fa-save me-1"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Usuário -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>Editar Usuário
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarUsuario">
                    {% csrf_token %}
                    <input type="hidden" name="usuario_id" id="edit-usuario-id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nome de Usuário</label>
                                <input type="text" class="form-control" name="username" id="edit-username" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" id="edit-email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nome Completo *</label>
                                <input type="text" class="form-control" name="first_name" id="edit-first-name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sobrenome</label>
                                <input type="text" class="form-control" name="last_name" id="edit-last-name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nova Senha</label>
                                <input type="password" class="form-control" name="password" placeholder="Deixe em branco para manter a atual">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Confirmar Nova Senha</label>
                                <input type="password" class="form-control" name="password_confirm" placeholder="Confirme a nova senha">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nível de Acesso *</label>
                                <select class="form-select" name="nivel_acesso" id="edit-nivel-acesso" required>
                                    <option value="visualizador">Visualizador</option>
                                    <option value="usuario">Usuário</option>
                                    <option value="gerente">Gerente</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status" id="edit-status">
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="suspenso">Suspenso</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="observacoes" id="edit-observacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="atualizarUsuario()">
                    <i class="fas fa-save me-1"></i>Atualizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Exclusão -->
<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o usuário <strong id="nome-usuario-excluir"></strong>?</p>
                <p class="text-muted">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarExclusao()">
                    <i class="fas fa-trash me-1"></i>Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let usuarioParaExcluir = null;

// Carregar dados quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    carregarUsuarios();
    carregarEstatisticas();
});

function carregarUsuarios() {
    fetch('/api/usuarios/perfis/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('lista-usuarios');
            tbody.innerHTML = '';
            
            data.forEach(usuario => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm me-3">
                                <i class="fas fa-user-circle fa-2x text-primary"></i>
                            </div>
                            <div>
                                <strong>${usuario.usuario.username}</strong>
                                <br><small class="text-muted">ID: ${usuario.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>${usuario.usuario.first_name} ${usuario.usuario.last_name || ''}</td>
                    <td>${usuario.usuario.email}</td>
                    <td>
                        <span class="badge bg-${getNivelClass(usuario.nivel_acesso)}">
                            ${getNivelDisplay(usuario.nivel_acesso)}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${getStatusClass(usuario.status)}">
                            ${getStatusDisplay(usuario.status)}
                        </span>
                    </td>
                    <td>${formatarData(usuario.ultimo_acesso)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editarUsuario(${usuario.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="verDetalhes(${usuario.id})" title="Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="mostrarSenhaUsuario(${usuario.id}, '${usuario.usuario.username}')" title="Mostrar Senha">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="excluirUsuario(${usuario.id}, '${usuario.usuario.username}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('total-resultados').textContent = data.length;
        })
        .catch(error => {
            console.error('Erro ao carregar usuários:', error);
            mostrarNotificacao('Erro ao carregar usuários', 'error');
        });
}

function carregarEstatisticas() {
    fetch('/api/usuarios/perfis/estatisticas/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-usuarios').textContent = data.total || 0;
            document.getElementById('usuarios-ativos').textContent = data.ativos || 0;
            document.getElementById('administradores').textContent = data.administradores || 0;
            document.getElementById('ultimo-acesso').textContent = data.ultimo_acesso || '-';
        })
        .catch(error => {
            console.error('Erro ao carregar estatísticas:', error);
        });
}

function abrirModalNovoUsuario() {
    document.getElementById('formNovoUsuario').reset();
    new bootstrap.Modal(document.getElementById('modalNovoUsuario')).show();
}

function salvarUsuario() {
    const form = document.getElementById('formNovoUsuario');
    const formData = new FormData(form);
    
    // Validar senhas
    if (formData.get('password') !== formData.get('password_confirm')) {
        mostrarNotificacao('As senhas não coincidem', 'error');
        return;
    }
    
    const data = {
        usuario: {
            username: formData.get('username'),
            email: formData.get('email'),
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            password: formData.get('password')
        },
        nivel_acesso: formData.get('nivel_acesso'),
        status: formData.get('status'),
        observacoes: formData.get('observacoes')
    };
    
    // Debug: mostrar dados sendo enviados
    console.log('Dados sendo enviados:', data);
    
    // Obter o token CSRF do formulário
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/api/usuarios/perfis/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                try {
                    const errorData = JSON.parse(text);
                    throw new Error(JSON.stringify(errorData));
                } catch (e) {
                    throw new Error(`Erro ${response.status}: ${text.substring(0, 200)}`);
                }
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.id) {
            mostrarNotificacao('Usuário criado com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalNovoUsuario')).hide();
            carregarUsuarios();
            carregarEstatisticas();
        } else {
            mostrarNotificacao('Erro ao criar usuário: ' + JSON.stringify(data), 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        let mensagemErro = 'Erro ao criar usuário';
        try {
            const errorData = JSON.parse(error.message);
            if (errorData && typeof errorData === 'object') {
                const erros = [];
                for (const [campo, mensagens] of Object.entries(errorData)) {
                    if (Array.isArray(mensagens)) {
                        erros.push(`${campo}: ${mensagens.join(', ')}`);
                    } else {
                        erros.push(`${campo}: ${mensagens}`);
                    }
                }
                mensagemErro = erros.join('; ');
            }
        } catch (e) {
            mensagemErro = error.message || 'Erro desconhecido';
        }
        mostrarNotificacao(mensagemErro, 'error');
    });
}

function editarUsuario(id) {
    fetch(`/api/usuarios/perfis/${id}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit-usuario-id').value = data.id;
            document.getElementById('edit-username').value = data.usuario.username;
            document.getElementById('edit-email').value = data.usuario.email;
            document.getElementById('edit-first-name').value = data.usuario.first_name;
            document.getElementById('edit-last-name').value = data.usuario.last_name || '';
            document.getElementById('edit-nivel-acesso').value = data.nivel_acesso;
            document.getElementById('edit-status').value = data.status;
            document.getElementById('edit-observacoes').value = data.observacoes || '';
            
            new bootstrap.Modal(document.getElementById('modalEditarUsuario')).show();
        })
        .catch(error => {
            console.error('Erro ao carregar usuário:', error);
            mostrarNotificacao('Erro ao carregar dados do usuário', 'error');
        });
}

function atualizarUsuario() {
    const form = document.getElementById('formEditarUsuario');
    const formData = new FormData(form);
    const id = document.getElementById('edit-usuario-id').value;
    
    // Validar senhas se fornecidas
    const password = formData.get('password');
    const passwordConfirm = formData.get('password_confirm');
    
    if (password && password !== passwordConfirm) {
        mostrarNotificacao('As senhas não coincidem', 'error');
        return;
    }
    
    const data = {
        usuario: {
            email: formData.get('email'),
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name')
        },
        nivel_acesso: formData.get('nivel_acesso'),
        status: formData.get('status'),
        observacoes: formData.get('observacoes')
    };
    
    if (password) {
        data.usuario.password = password;
    }
    
    // Obter o token CSRF do formulário
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/api/usuarios/perfis/${id}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                try {
                    const errorData = JSON.parse(text);
                    throw new Error(JSON.stringify(errorData));
                } catch (e) {
                    throw new Error(`Erro ${response.status}: ${text.substring(0, 200)}`);
                }
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.id) {
            mostrarNotificacao('Usuário atualizado com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
            carregarUsuarios();
            carregarEstatisticas();
        } else {
            mostrarNotificacao('Erro ao atualizar usuário: ' + JSON.stringify(data), 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        let mensagemErro = 'Erro ao atualizar usuário';
        try {
            const errorData = JSON.parse(error.message);
            if (errorData && typeof errorData === 'object') {
                const erros = [];
                for (const [campo, mensagens] of Object.entries(errorData)) {
                    if (Array.isArray(mensagens)) {
                        erros.push(`${campo}: ${mensagens.join(', ')}`);
                    } else {
                        erros.push(`${campo}: ${mensagens}`);
                    }
                }
                mensagemErro = erros.join('; ');
            }
        } catch (e) {
            mensagemErro = error.message || 'Erro desconhecido';
        }
        mostrarNotificacao(mensagemErro, 'error');
    });
}

function excluirUsuario(id, nome) {
    usuarioParaExcluir = { id, nome };
    document.getElementById('nome-usuario-excluir').textContent = nome;
    new bootstrap.Modal(document.getElementById('modalConfirmarExclusao')).show();
}

function confirmarExclusao() {
    if (!usuarioParaExcluir) return;
    
    fetch(`/api/usuarios/perfis/${usuarioParaExcluir.id}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            mostrarNotificacao('Usuário excluído com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalConfirmarExclusao')).hide();
            carregarUsuarios();
            carregarEstatisticas();
        } else {
            mostrarNotificacao('Erro ao excluir usuário', 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao excluir usuário', 'error');
    });
}

function verDetalhes(id) {
    // Implementar visualização detalhada do usuário
    window.open(`/usuarios/${id}/`, '_blank');
}

function mostrarSenhaUsuario(id, username) {
    // Modal para mostrar senha do usuário
    const modal = `
        <div class="modal fade" id="modalMostrarSenha" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-key me-2"></i>Senha do Usuário
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atenção!</strong> Esta funcionalidade permite visualizar a senha do usuário.
                            <br>Certifique-se de que ninguém está vendo sua tela!
                        </div>
                        <h6>Usuário: <strong>${username}</strong></h6>
                        <p class="text-muted">A senha será exibida temporariamente</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Senha Atual:</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="senha-usuario" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleSenhaUsuario()">
                                    <i class="fas fa-eye" id="icon-senha-usuario"></i>
                                </button>
                                <button class="btn btn-outline-primary" type="button" onclick="copiarSenhaUsuario()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nova Senha (opcional):</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="nova-senha-usuario" placeholder="Deixe em branco para manter a atual">
                                <button class="btn btn-outline-warning" type="button" onclick="gerarNovaSenha()">
                                    <i class="fas fa-random"></i>
                                </button>
                            </div>
                        </div>
                        
                        <small class="text-muted">A senha será ocultada quando você fechar este modal</small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarNovaSenha(${id})">
                            <i class="fas fa-save me-1"></i>Salvar Nova Senha
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior se existir
    $('#modalMostrarSenha').remove();
    
    // Adicionar novo modal
    $('body').append(modal);
    
    // Carregar senha do usuário
    fetch(`/api/usuarios/perfis/${id}/mostrar_senha/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('senha-usuario').value = data.senha || '********';
            $('#modalMostrarSenha').modal('show');
        })
        .catch(error => {
            console.error('Erro:', error);
            // Se não conseguir carregar a senha, mostrar modal sem senha
            document.getElementById('senha-usuario').value = '********';
            $('#modalMostrarSenha').modal('show');
        });
}

function toggleSenhaUsuario() {
    const campo = document.getElementById('senha-usuario');
    const icon = document.getElementById('icon-senha-usuario');
    
    if (campo.type === 'password') {
        campo.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        campo.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function copiarSenhaUsuario() {
    const senha = document.getElementById('senha-usuario').value;
    navigator.clipboard.writeText(senha).then(() => {
        mostrarNotificacao('Senha copiada para a área de transferência!', 'success');
    });
}

function gerarNovaSenha() {
    const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let senha = '';
    for (let i = 0; i < 12; i++) {
        senha += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
    }
    document.getElementById('nova-senha-usuario').value = senha;
}

function salvarNovaSenha(id) {
    const novaSenha = document.getElementById('nova-senha-usuario').value;
    
    if (!novaSenha) {
        mostrarNotificacao('Digite uma nova senha ou deixe em branco', 'warning');
        return;
    }
    
    const data = {
        usuario: {
            password: novaSenha
        }
    };
    
    // Obter o token CSRF do formulário
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/api/usuarios/perfis/${id}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                try {
                    const errorData = JSON.parse(text);
                    throw new Error(JSON.stringify(errorData));
                } catch (e) {
                    throw new Error(`Erro ${response.status}: ${text.substring(0, 200)}`);
                }
            });
        }
        return response.json();
    })
    .then(data => {
        mostrarNotificacao('Senha atualizada com sucesso!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('modalMostrarSenha')).hide();
        // Limpar campo de nova senha
        document.getElementById('nova-senha-usuario').value = '';
    })
    .catch(error => {
        console.error('Erro:', error);
        let mensagemErro = 'Erro ao atualizar senha';
        try {
            const errorData = JSON.parse(error.message);
            if (errorData && typeof errorData === 'object') {
                const erros = [];
                for (const [campo, mensagens] of Object.entries(errorData)) {
                    if (Array.isArray(mensagens)) {
                        erros.push(`${campo}: ${mensagens.join(', ')}`);
                    } else {
                        erros.push(`${campo}: ${mensagens}`);
                    }
                }
                mensagemErro = erros.join('; ');
            }
        } catch (e) {
            mensagemErro = error.message || 'Erro desconhecido';
        }
        mostrarNotificacao(mensagemErro, 'error');
    });
}

function aplicarFiltros() {
    const busca = document.getElementById('buscar-usuario').value;
    const status = document.getElementById('filtro-status').value;
    const nivel = document.getElementById('filtro-nivel').value;
    const ordenar = document.getElementById('ordenar-por').value;
    
    // Implementar filtros na API
    carregarUsuarios();
}

function limparFiltros() {
    document.getElementById('buscar-usuario').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-nivel').value = '';
    document.getElementById('ordenar-por').value = 'nome';
    carregarUsuarios();
}

function getNivelClass(nivel) {
    const classes = {
        'admin': 'danger',
        'gerente': 'warning',
        'usuario': 'primary',
        'visualizador': 'secondary'
    };
    return classes[nivel] || 'secondary';
}

function getNivelDisplay(nivel) {
    const displays = {
        'admin': 'Administrador',
        'gerente': 'Gerente',
        'usuario': 'Usuário',
        'visualizador': 'Visualizador'
    };
    return displays[nivel] || nivel;
}

function getStatusClass(status) {
    const classes = {
        'ativo': 'success',
        'inativo': 'secondary',
        'suspenso': 'warning'
    };
    return classes[status] || 'secondary';
}

function getStatusDisplay(status) {
    const displays = {
        'ativo': 'Ativo',
        'inativo': 'Inativo',
        'suspenso': 'Suspenso'
    };
    return displays[status] || status;
}

function formatarData(data) {
    if (!data) return '-';
    return new Date(data).toLocaleDateString('pt-BR');
}

function mostrarNotificacao(mensagem, tipo) {
    const alertClass = tipo === 'success' ? 'alert-success' : 
                      tipo === 'error' ? 'alert-danger' : 
                      tipo === 'warning' ? 'alert-warning' : 'alert-info';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 